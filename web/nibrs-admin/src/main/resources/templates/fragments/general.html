<!--

    Copyright 2016 SEARCH-The National Consortium for Justice Information and Statistics

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:fragment="headerfiles">
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" type="text/css" th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/datatables/1.10.19/css/dataTables.bootstrap4.min.css}" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.5/css/fixedHeader.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" th:href="@{/webjars/font-awesome/5.2.0/css/all.css}" />
  <link href="https://cdn.jsdelivr.net/npm/gijgo@1.9.10/css/gijgo.min.css" rel="stylesheet" type="text/css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css" rel="stylesheet" type="text/css" />
  <link href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" th:href="@{/css/style.css}" href="../../css/style.css" />
</head>
<body>
    <header th:fragment="header">
        <div class="banner mt-5 pt-1" th:fragment="banner">
          <div class="text-white pl-3">
            <img th:src="@{/images/oklahoma_logo.png}" height="75px" /> 
            <span class="initials align-bottom" aria-hidden="true">NIBRS</span>
            <span class="fullname align-middle">Record of NIBRS submissions</span>
          </div>
        </div>
	      <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
	        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
	          <span class="navbar-toggler-icon"></span>
	        </button>
	        <div class="collapse navbar-collapse" id="navbarCollapse">
	          <ul class="navbar-nav mr-auto text-white">
	            <li class="nav-item active">
	              <a class="nav-link" th:href="@{/}" id="home">Home <span class="sr-only">(current)</span></a>
	            </li>
	            <li class="nav-item">
	              <a class="nav-link" href="#" id="incidents">Incidents</a>
	            </li>
	            <li class="nav-item">
	              <a class="nav-link" href="#" id="upload">Validate</a>
	            </li>
	          </ul>
	          
	          <ul class="navbar-nav flex-row ml-md-auto d-md-flex" sec:authorize="isAuthenticated()">
              <li class="nav-item dropdown">
	              <a class="nav-link dropdown-toggle text-primary" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				          <i class="fas fa-user-circle fa-lg"></i>
		            </a>
			          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
			            <a class="dropdown-item disabled"><span class="small font-italic pr-2 text-secondary">Signed in as <strong th:text="${#authentication.getPrincipal().getUsername()}"></strong></span></a>
			            <div class="dropdown-divider"></div>
			            <a class="dropdown-item" th:href="@{/logout}"><span class="small font-italic pr-2">Sign Out</span> <i class="fas fa-sign-out-alt"></i></a>
			          </div>
              </li>
            </ul>
	        </div>
	      </nav>
      </header>
	    <p>Go to the next page to see fragments in action</p>
	    <footer class="footer" th:fragment="footer">
	      <div class="container" align="center">
	        <span class="text-muted">NIBRS admin tool</span>
	      </div>
	    </footer>
    
    <div th:fragment="javascripts">
   	    <!-- Optional JavaScript -->
	    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
			<script th:src="@{/webjars/jquery/3.3.1/jquery.min.js}"></script>
			<script th:src="@{/webjars/popper.js/1.14.4/dist/umd/popper.min.js}"></script>
	        <script type="text/javascript" th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
			<script type="text/javascript" th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
		    <script type="text/javascript" th:src="@{/webjars/datatables/1.10.19/js/dataTables.bootstrap4.min.js}"></script>
		    <script type="text/javascript" th:src="@{/webjars/datatables-fixedheader/3.1.4/js/dataTables.fixedHeader.js}"></script>
		    <script type="text/javascript" th:src="@{/webjars/datatables-responsive/2.2.3/js/dataTables.responsive.js}"></script>
		    <script type="text/javascript" th:src="@{/webjars/font-awesome/5.2.0/js/all.js}"></script>
		    <script src="https://cdn.jsdelivr.net/npm/gijgo@1.9.10/js/gijgo.min.js" type="text/javascript"></script>
			<!-- <script type="text/javascript" th:src="@{/webjars/jquery-maskedinput/1.4.0/jquery.maskedinput.js}"></script> --> 
			<script type="text/javascript" th:src="@{/js/plugins/jquery.mask.min.js}"></script> 
			<script type="text/javascript" th:src="@{/js/plugins/bootpopup.js}"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.19/sorting/datetime-moment.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script> 
			<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script> 
			<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script> 
	    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.colVis.min.js"></script> 
			<script th:inline="javascript">
		     /*<![CDATA[*/
		        var context = [[@{/}]];
		       	var inactivityTimeout = [[${inactivityTimeout}]]; 
		       	var inactivityTimeoutInSeconds = [[${inactivityTimeoutInSeconds}]]; 
		     /*]]>*/
		      var idleTime;
	
		      $(function(){
		    	  if( inactivityTimeout ){
	       		  ojbc.reloadPage();
	 	          $('html').on('mousemove click mouseup mousedown keydown keypress keyup submit change mouseenter scroll resize dblclick', function () {
	 	              clearTimeout(idleTime);
	 	              ojbc.reloadPage();
	 	          });
	       	  }
	   	      
		    	  $('body').on('click', 'a#incidents', function() {   
							$(this).parent().toggleClass('show');
							
							xhr = $.get(context + 'incidents/searchForm', function(data) {
							   $('#portalContent').html(data); 
							 }).fail(ojbc.displayFailMessage);
							return false; 
	          });
		    	  
		    	  $('body').on('click', 'a#upload', function() {   
							$(this).parent().toggleClass('show');
							
							xhr = $.get(context + 'files/upload', function(data) {
							   $('#portalContent').html(data); 
							 }).fail(ojbc.displayFailMessage);
							return false; 
	          });
		    	  
	          $(document).ajaxStart(function(){
							if( $(".ojbc-modal").is(':visible')){
								var visibleOjbcModal = $(".ojbc-modal:visible");
								var modalDialog = visibleOjbcModal.children(".modal-dialog"); 
								var loadingDiv = visibleOjbcModal.children(".modalIframeSpinner");
			                
								console.log("modalDialog.height():" + modalDialog.height()); 
								console.log("modalDialog.height() + parseInt( modalDialog.css('margin-top'), 10):" + modalDialog.height() + parseInt( modalDialog.css("margin-top"), 10)); 
								console.log("modalDialog.css('margin-top'):" + modalDialog.css("margin-top")); 
								console.log("visibleOjbcModal.width():" + visibleOjbcModal.width()); 
								loadingDiv.height(modalDialog.height() + parseInt( modalDialog.css("margin-top"), 10));
								loadingDiv.width(visibleOjbcModal.width());
								
								loadingDiv.show();           
				          
							}
							else if ($('#dropzone').is(':visible')){
						        $("#loadingFileAjaxPane").css({"display": "block"}); 
							}
							else{
								var loadingDiv =  $("#loadingAjaxPane");
								var portalContentDiv = $("#portalContent");
								
								loadingDiv.height(portalContentDiv.height());
								loadingDiv.width(portalContentDiv.width());
								
								$("#loadingAjaxPane").show();           
							}               
	          }).ajaxStop(function() {
	            $("#loadingAjaxPane").hide();                
	            $(".modalIframeSpinner").hide();
	            $("#loadingFileAjaxPane").css({"display": "none"});                
	          });
	 	          
	          $('[data-toggle="popover"]').popover(); 
	 	          
		      });
		      
	        ojbc = {
        	    handleEsc:function(){
        	        $("body").on("keyup", function(event){
        	           if ( event.keyCode == 27 ) {
        	             event.preventDefault();
        	             event.stopPropagation();
        	             console.log("xhr is null:" +  xhr===null);
        	             if(xhr && xhr.readyState != 4){
        	               xhr.textStatus="aborted"; 
        	               xhr.abort();
        	             }
        	         }
        	        }); 
        	     },
        	     
		          displayFailMessage : function(jqXHR, textStatus, errorThrown) {
		            if (jqXHR.status == 500) {
		              var errorHeader = "A server-side error occurred while processing your request. Please contact the IT department or try again later.";
		              bootpopup.alert(errorHeader, "Error");   
		            } else if (jqXHR.status == 0) {
		              if (jqXHR.textStatus != "aborted"){
		                window.location.reload();
		              }
		            } else if (jqXHR.status == 403) {
	                bootpopup.alert("Access is denied. Please check if you have the access right for the item.", "Error");
	              } else {
		          	  bootpopup.alert("Unable to talk to Server.  Please try again later.", "Error");
		            }
		         }, 
		         
		         reloadPage: function() {
		             clearTimeout(idleTime);
		             idleTime = setTimeout(function () {
		                 window.location.assign(context + "logout");
		             }, inactivityTimeoutInSeconds * 1000);
		         }
	         };
	              

      </script>
		  
	  </div>		
    
</body>
</html>